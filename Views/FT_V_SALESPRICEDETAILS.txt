DROP VIEW FT_V_SALESPRICEDETAILS;

/* Formatted on 27/04/2015 13:52:38 (QP5 v5.115.810.9015) */
CREATE OR REPLACE FORCE VIEW FT_V_SALESPRICEDETAILS
(
--CUSTOMER
   CUSTOMER_CLARECNO,   CUSTOMER_CODE,   CUSTOMER_DESC,
   
-- SALES OFFICE
   SALESOFFICENO,  SALESOFFICEDESC,     
-- ORDERS   
   ORDRECNO, ORDCUSTORDNO, ORDSALTYP, ISEDIORD, EDIUPLRECNO,
-- SALESMAN   
   ORDSMNNO,   ORDSMNNAME,
-- SALES DEPARTMENT      
   DLVDPTRECNO, DLVDEPARTMENTDESC,
-- DELIVERY HEADER   
   DLVORDNO,   DLVDELDATE,  DLVSHPDATE,  DLVRELINV, 
   ISOPENFORMORE, CREDITCONTROLHOLD, 
   DLVSALTYP, DLVSALTYPDESC, 
-- DELIVERY STOCK LOCATION
   DLVSTKLOC,   STCLOCDESC,
-- TRANSHIPMENT DETAILS
   DLVISTRANSHIP,   DLVTRANSSHIP, TRANSSHIPTOLOC, TRANSSHIPTOLOCDESC,   

-- TRANSFER DETAILS            
    DLVISTRANSFER, TRANSFERFLG, TRANSFER_SO_DESC,

-- DELIVERY CURRENCY
   DLVCURRECNO, CURRENCY_SYMBOL,CURRENCY_DESC,      
            
-- DELIVERY HEADER COMMENT
   DLVCOMNO,   DLVCOMMENT,

-- TICKET NUMBER
   TICKETNO,
-- PRICE METHOD   
   DLVDLTRECNO,   PRICEMETHOD,
   
-- OTHER DELIVERY HEADER DETAILS   
   DELHEDDLVPRTSTAT,   DELHEDDLVPRTSTATDESC,
   HEDSYSCALCPALS,   USERINPPALS,      INTERDEPTFLAG,
   
-- DELIVERY dETAILS 
   DELRECNO,    DELPRCPRDNO,    DELCLTPRDNO,    DELQTY,
   
-- DELIVERY DETAIL COMMENT    
   DELCOMNO,   DELCOMMENT,
   DELSTATUS,
   DELDETPIKPRTSTAT,    DELHEDPIKPRTSTATDESC,
   DELDETDLVPRTSTAT,    DELDETDLVPRTSTATDESC,
   
-- DELIVERY DETAIL SALESMAN   
   DELDETSMNNO,         DELDETSMNNAME,
   
-- DELPRICE   
   DPRRECNO,    DELPRICE_PRICE,    DELNETTVALUE,    DELVATVALUE,    DELFREEOFCHG,
   MULTIPLIER, 
   DELTOEURORATE, DELTOBASERATE, DELEURONETTVAL, DELBASENETTVAL, 
   DELPRICEPER,   DELPRICEPERCHAR,   DELPRICEPERDESC,     
   DELQTYPER,    DELQTYPERCHAR,   DELQTYPERDESC,
   DELPRICE_INVSTATUS,    DELPRICE_INVSTATUSDESC,
-- PRICE REASONS                        
   DPRPREAS,    DPRPREASDESC,
   
-- OTHER   
   PALTODEL_CNT,
   DELTOALL_CNT,
   ANYDELTOALL_STKDISS,
   TOT_DELTOALLQTY,
   ANYOVERSOLDPOS,
   
--PRODUCTS   
   PRODUCT_DESCRIPTION, PRODUCT_REFERENCE, PRODUCT_SHORTDESC,
   PRODUCT_LEVEL1_CODE, PRODUCT_LEVEL1_DESC,
   PRODUCT_LEVEL2_CODE, PRODUCT_LEVEL2_DESC,
   PRODUCT_LEVEL3_CODE, PRODUCT_LEVEL3_DESC,
   PRODUCT_LEVEL4_CODE, PRODUCT_LEVEL4_DESC,
   PRODUCT_LEVEL5_CODE, PRODUCT_LEVEL5_DESC,
   PRODUCT_LEVEL6_CODE, PRODUCT_LEVEL6_DESC,
   PRODUCT_DEFAULTFLAG
            
)
AS
   SELECT                                                            
--CUSTOMER 
         ORDERS.ACTCSTCODE CUSTOMER_CLARECNO,
            (BSDL_PKAGE_ACCOUNTS.GETACCCODE (ORDERS.ACTCSTCODE, 2)) CUSTOMER_CODE,
            (SELECT   ACCOUNTS.ACCNAME FROM   ACCCLASS, ACCOUNTS WHERE   ACCCLASS.CLAACCNO = ACCOUNTS.ACCRECNO AND ACCCLASS.CLARECNO = ORDERS.ACTCSTCODE) CUSTOMER_DESC,
-- SALES OFFICE            
            DELHED.DLVSALOFFNO SALESOFFICENO, 
            (SELECT SALOFFDESC FROM SALOFFNO WHERE DELHED.DLVSALOFFNO = SALOFFNO.SALOFFNO) SALESOFFICEDESC,
-- ORDERS               
            ORDERS.ORDRECNO, ORDERS.ORDCUSTORDNO, ORDERS.ORDSALTYP, ORDERS.ISEDIORD, ORDERS.EDIUPLRECNO,
-- SALESMAN            
            ORDERS.ORDSMNNO AS ORDSMNNO,
            (SELECT   SMN.SMNNAME
               FROM   SMN
              WHERE   SMN.SMNNO = ORDERS.ORDSMNNO)
               ORDSMNNAME,
-- SALES DEPARTMENT                     
            (CASE
                WHEN (SELECT   COUNT (DPTRECNO)
                        FROM   DEPARTMENTSTOSMN
                       WHERE   DEPARTMENTSTOSMN.SMNNO = ORDERS.ORDSMNNO) > 1
                THEN
                   NULL
                ELSE
                   (SELECT   DEPARTMENTSTOSMN.DPTRECNO
                      FROM   DEPARTMENTSTOSMN
                     WHERE   DEPARTMENTSTOSMN.SMNNO = ORDERS.ORDSMNNO)
             END)
               DLVDPTRECNO,
            (CASE
                WHEN (SELECT   COUNT (DPTRECNO)
                        FROM   DEPARTMENTSTOSMN
                       WHERE   DEPARTMENTSTOSMN.SMNNO = ORDERS.ORDSMNNO) > 1
                THEN
                   '*'
                ELSE
                   (SELECT   DPT_DESC
                      FROM   DEPARTMENTSTOSMN, DEPARTMENTS
                     WHERE   DEPARTMENTSTOSMN.DPTRECNO = DEPARTMENTS.DPTRECNO
                             AND DEPARTMENTSTOSMN.SMNNO = ORDERS.ORDSMNNO)
             END)
               DLVDEPARTMENTDESC,
-- DELIVERY HEADER
            DELHED.DLVORDNO, DELHED.DLVDELDATE,  DELHED.DLVSHPDATE, DELHED.DLVRELINV, 
            DELHED.ISOPENFORMORE, DELHED.CREDITCONTROLHOLD,  
            DELHED.DLVSALTYP,
            (CASE DELHED.DLVSALTYP WHEN 'S' THEN 'Normal Sale' ELSE CASE DELHED.DLVSALTYP WHEN 'T' THEN 'Third Party' WHEN 'R' THEN 'RTS' ELSE '' END  END) AS DLVSALTYPDESC,
-- DELIVERY STOCK LOCATION                        
            DELHED.DLVSTKLOC,
            (SELECT   STOCLOC.STCLOCDESC FROM   STOCLOC WHERE   STOCLOC.STCRECNO = DELHED.DLVSTKLOC) STCLOCDESC,
-- TRANSHIPMENT DETAILS
            (CASE WHEN NVL(DELHED.DLVTRANSSHIP,0) > 0 THEN 1 ELSE 0 END) DLVISTRANSHIP,
            DELHED.DLVTRANSSHIP DLVTRANSSHIP,
            DELHED.DLVTRANSSHIPTOLOC TRANSSHIPTOLOC,
            (SELECT   STOCLOC.STCLOCDESC FROM   STOCLOC WHERE   STOCLOC.STCRECNO = DELHED.DLVTRANSSHIPTOLOC) TRANSSHIPTOLOCDESC,

-- TRANSFER DETAILS
            (CASE WHEN NVL(DELHED.TRANSFERFLG,0) > 0 THEN 1 ELSE 0 END) DLVISTRANSFER,
            DELHED.TRANSFERFLG TRANSFERFLG,
            (SELECT SALOFFDESC FROM SALOFFNO WHERE SALOFFNO.SALOFFNO = DELHED.TRNSALOFFNO) TRANSFER_SO_DESC,
            
-- DELIVERY CURRENCY            
            DELHED.DLVCURRECNO,
            (SELECT CURSYMBOL FROM ACCCURRDESC WHERE DELHED.DLVCURRECNO = ACCCURRDESC.CURNO)  CURRENCY_SYMBOL,
            (SELECT CURDESC FROM ACCCURRDESC WHERE DELHED.DLVCURRECNO = ACCCURRDESC.CURNO)    CURRENCY_DESC,
                  
-- DELIVERY HEADER COMMENT            
            DELHED.DLVCOMNO,
            (SELECT   MIN (DELCOMM)  FROM   DELCOMMS  WHERE       DELCOMMTYPRECNO = DELHED.DLVORDNO AND DELTYP = 3 AND DELCOMMS.DELCOMMSEQ = 1) DLVCOMMENT,
            
-- TICKET NUMBER
            (SELECT TNTNO FROM TKTNT WHERE TKTNT.TNTDLVORDNO = DELHED.DLVORDNO) TICKETNO,
            
-- PRICE METHOD              
            DELHED.DLVDLTRECNO, 
            (SELECT DELIVERYCONDITIONDESC FROM DLVTYPE WHERE DELHED.DLVDLTRECNO = DLVTYPE.DLTRECNO) PRICEMETHOD,
            
-- OTHER DELIVERY HEADER DETAILS               
            NVL (DELHED.DLVPRTSTAT, 0) DELHEDDLVPRTSTAT,
            (SELECT   MIN (LKUPDESC) FROM   LOOKUPS WHERE       LKUPTABLE = 'DELHED' AND LKUPFIELDNAME = 'DLVPRTSTAT' AND LKUPNO = DELHED.DLVPRTSTAT) DELHEDDLVPRTSTATDESC,
            
            DELHED.HEDSYSCALCPALS,
            DELHED.USERINPPALS,
            DELHED.INTERDEPTFLAG,
            
-- DELIVERY DETAILS 
            DELDET.DELRECNO,            DELDET.DELPRCPRDNO,            DELDET.DELCLTPRDNO,            NVL (DELDET.DELQTY, 0) DELQTY,
            
-- DELIVERY DETAIL COMMENT
            DELDET.DELCOMNO,
            (SELECT   MIN (DELCOMM) FROM   DELCOMMS WHERE       DELCOMMTYPRECNO = DELDET.DELRECNO AND DELTYP = 4 AND DELCOMMS.DELCOMMSEQ = 1) DELCOMMENT,
            
            DELDET.DELSTATUS,
            NVL (DELDET.PRTSTAT, 0) DELDETPIKPRTSTAT,
            (SELECT   MIN (LKUPDESC) FROM   LOOKUPS WHERE       LKUPTABLE = 'DELDET' AND LKUPFIELDNAME = 'PRTSTAT' AND LKUPNO = DELDET.PRTSTAT) DELDETPIKPRTSTATDESC,
            NVL (DELDET.DLVPRTSTAT, 0) DELDETDLVPRTSTAT,
            (SELECT   MIN (LKUPDESC) FROM   LOOKUPS WHERE       LKUPTABLE = 'DELDET' AND LKUPFIELDNAME = 'DLVPRTSTAT' AND LKUPNO = DELDET.DLVPRTSTAT) DELDETDLVPRTSTATDESC,

-- DELIVERY DETAIL SALESMAN            
            DELDET.DELSMNNO DELDETSMNNO,
            (SELECT   SMNNAME FROM   SMN WHERE   SMN.SMNNO = DELDET.DELSMNNO) DELDETSMNNAME,

--DELIVERY PRICE
            DELPRICE.DPRRECNO DPRRECNO,
            DELPRICE.DELPRICE DELPRICE_PRICE,
            DELPRICE.DELNETTVALUE DELNETTVALUE,
            DELPRICE.DELVATVALUE DELVATVALUE,
            DELPRICE.DELFREEOFCHG DELFREEOFCHG,
            DELNETTWEIGHT MULTIPLIER, 
            DELTOEURORATE, DELTOBASERATE, DELEURONETTVAL, DELBASENETTVAL,
            
            NVL (DELDET.DELPRICEPER, 1) DELPRICEPER,
            (SELECT   UPPER (SUBSTR (MIN (LKUPDESC), 1, 1))
               FROM   LOOKUPS
              WHERE       LKUPTABLE = 'MARKETDELDETS'
                      AND LKUPFIELDNAME = 'PRCBYWGT'
                      AND LKUPNO = NVL (DELDET.DELPRICEPER, 1))
               DELPRICEPERCHAR,
            (SELECT   MIN (LKUPDESC)
               FROM   LOOKUPS
              WHERE       LKUPTABLE = 'MARKETDELDETS'
                      AND LKUPFIELDNAME = 'PRCBYWGT'
                      AND LKUPNO = NVL (DELDET.DELPRICEPER, 1))
               DELPRICEPERDESC,
            NVL (DELDET.DELQTYPER, 1) DELQTYPER,
            (SELECT   UPPER (SUBSTR (MIN (LKUPDESC), 1, 1))
               FROM   LOOKUPS
              WHERE       LKUPTABLE = 'MARKETDELDETS'
                      AND LKUPFIELDNAME = 'PRCBYWGT'
                      AND LKUPNO = NVL (DELDET.DELQTYPER, 1))
               DELQTYPERCHAR,
            (SELECT   MIN (LKUPDESC)
               FROM   LOOKUPS
              WHERE       LKUPTABLE = 'MARKETDELDETS'
                      AND LKUPFIELDNAME = 'PRCBYWGT'
                      AND LKUPNO = NVL (DELDET.DELQTYPER, 1))
               DELQTYPERDESC,            
   
            DELPRICE.DELINVSTATUS DELPRICE_INVSTATUS,
            (SELECT LKUPDESC FROM LOOKUPS WHERE LKUPTABLE = 'DELPRICE' AND LKUPFIELDNAME = 'DELINVSTATUS' AND LOOKUPS.LKUPNO = DELPRICE.DELINVSTATUS) DELPRICE_INVSTATUSDESC,
            
-- PRICE REASONS
            DELPRICE.DPRPREAS DPRPREAS,            
            (SELECT   PREASCOMM.PRESCOMM FROM   PREASCOMM WHERE DELPRICE.DPRPREAS = PREASCOMM.PRESCOMMRECNO) DPRPREASDESC,

-- OTHER
            NVL ( (SELECT   COUNT (PALLOCRECNO) CNT
                     FROM   PALTODEL
                    WHERE   PALTODEL.pallocdelrecno = DELDET.DELRECNO), 0)
               PALTODEL_CNT,
            NVL (
               (SELECT   COUNT (DALWIZUNIQUEID) CNT
                  FROM   DELTOALL SUBDELTOALL
                 WHERE   SUBDELTOALL.DALTYPERECNO = DELDET.DELRECNO
                         AND SUBDELTOALL.DALRECORDTYPE = 1),
               0
            )
               DELTOALL_CNT,
            NVL (
               (SELECT   COUNT (DALWIZUNIQUEID) CNT
                  FROM   DELTOALL SUBDELTOALL
                 WHERE       SUBDELTOALL.DALTYPERECNO = DELDET.DELRECNO
                         AND SUBDELTOALL.DALRECORDTYPE = 1
                         AND NVL (SUBDELTOALL.ALLFLAG, 0) = 1),
               0
            )
               ANYDELTOALL_STKDISS,
            NVL (
               (SELECT   (CASE
                             WHEN DELDET.DELQTYPER = 1
                             THEN
                                SUM (NVL (SUBDELTOALL.DALQTY, 0))
                             ELSE
                                SUM (NVL (SUBDELTOALL.ACTSPLITQTY, 0))
                          END)
                  FROM   DELTOALL SUBDELTOALL
                 WHERE   SUBDELTOALL.DALTYPERECNO = DELDET.DELRECNO
                         AND SUBDELTOALL.DALRECORDTYPE = 1),
               0
            )
               TOT_DELTOALLQTY,
            (SELECT   COUNT ( * ) ANYOVERSOLDPOS
               FROM   DELTOALL SUBDELTOALL,
                      ALLOCATE SUBALLOCATE,
                      LOTITE SUBLOTITE
              WHERE       DELDET.DELRECNO = SUBDELTOALL.DALTYPERECNO
                      AND SUBDELTOALL.DALRECORDTYPE = 1
                      AND SUBDELTOALL.DALALLOCNO = SUBALLOCATE.ALLOCNO
                      AND SUBLOTITE.LITITENO = SUBALLOCATE.ALLOCLITITENO
                      AND POTYPEIND = 2)
               ANYOVERSOLDPOS,
            
-- PRODUCTS
            PRODUCTS.PRODUCT_DESCRIPTION,
            PRODUCTS.PRODUCT_REFERENCE,
            FT_PK_PRODUCTS.GETPRDSHORTCODE (DELDET.DELPRCPRDNO, DELHED.DLVSALOFFNO) PRCSHORTDESC,
            PRODUCTS.PRODUCT_LEVEL1_CODE, PRODUCTS.PRODUCT_LEVEL1_DESC,
            PRODUCTS.PRODUCT_LEVEL2_CODE, PRODUCTS.PRODUCT_LEVEL2_DESC,
            PRODUCTS.PRODUCT_LEVEL3_CODE, PRODUCTS.PRODUCT_LEVEL3_DESC,
            PRODUCTS.PRODUCT_LEVEL4_CODE, PRODUCTS.PRODUCT_LEVEL4_DESC,
            PRODUCTS.PRODUCT_LEVEL5_CODE, PRODUCTS.PRODUCT_LEVEL5_DESC,
            PRODUCTS.PRODUCT_LEVEL6_CODE, PRODUCTS.PRODUCT_LEVEL6_DESC,
                        
            PRODUCT_ISDEFAULT DEFAULTPRD
     FROM   DELHED,
            ORDERS,
            DELDET,
            DELPRICE,
            FT_V_PRODUCTS PRODUCTS
    WHERE       DELHED.DLVORDRECNO = ORDERS.ORDRECNO
            AND DELHED.DLVORDNO = DELDET.DELDLVORDNO
            AND DELDET.DELRECNO = DELPRICE.DPRDELRECNO
            AND DELDET.DELPRCPRDNO = PRODUCTS.PRODUCT_NUMBER
            --and delhed.dlvordno = 322635
            ;            

COMMENT ON TABLE FT_V_SALESPRICEDETAILS IS '11.0.1';

